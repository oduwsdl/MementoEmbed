<html lang="en">
    <head>
        <title>MementoEmbed - Create Embeddable Content of your Mementos</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <style>
            /* #waitingimage {
                width: 13px;
                opacity: 0;
            } */
            
            #embedWorkStatus {
                visibility: hidden;
            }

            #mementoDataFailure,
            #originalDataFailure,
            #textDataFailure,
            #imageDataFailure,
            #mementoDataSuccess,
            #originalDataSuccess,
            #textDataSuccess,
            #imageDataSuccess {
                display: none;
            }

            /* .successImage {
                background-color: #009933;
                color: #ffffff;
                font-weight: bolder;
            } */

        </style>

    </head>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <div class="container">
            <h1 style="text-align: center">MementoEmbed</h1>
            <div class="row">
                <div class="col-sm" style="text-align: center">
                    <p>Generate an embeddable social card of a memento for your web page or blog. Just enter a URL below.</p>
                    <p>If the URL is not a memento, it will be submitted to a web archive and your embeddable card will point to a memento.</p>
                </div>
            </div>
            <div class="row" style="text-align: center">
                <div class="col-sm" style="text-align: center">
                    <form action="#">
                    <input type="text" id="uri_submitted" class="form-control form-control-lg" size="100" placeholder="Type URL here">
                    <br />
                    <button type="submit" class="btn btn-primary" onclick="requestEmbed();">Create a Social Card</button>
                    <button type="reset" class="btn btn-secondary" onclick="clearEmbed();">Clear URI</button>
                    </form>
                </div>
            </div>
            <div class="row" style="text-align: center">
                <div class="col-sm" style="text-align: center">
                    <hr />
                    <div id="embedWorkArea">
                        <div id="embedWorkStatus">
                            <div class="row">
                                <div class="col-sm"></div>
                                <div class="col-sm" style="text-align: left">Memento Data</div>
                                <div class="col-sm">
                                    <img src="/static/images/ajax-loader.gif" id="mementoDataWaiting">
                                    <div id="mementoDataSuccess">✅</div>
                                    <div id="mementoDataFailure">❌</div>
                                </div>
                                <div class="col-sm"></div>
                            </div>
                            <div class="row">
                                <div class="col-sm"></div>
                                <div class="col-sm" style="text-align: left">Original Resource Data</div>
                                <div class="col-sm">
                                    <img src="/static/images/ajax-loader.gif" id="originalDataWaiting">
                                    <div id="originalDataSuccess">✅</div>
                                    <div id="originalDataFailure">❌</div>
                                </div>
                                <div class="col-sm"></div>
                            </div>
                            <div class="row">
                                <div class="col-sm"></div>
                                <div class="col-sm" style="text-align: left">Text Analysis</div>
                                <div class="col-sm">
                                    <img src="/static/images/ajax-loader.gif" id="textDataWaiting">
                                    <div id="textDataSuccess">✅</div>
                                    <div id="textDataFailure">❌</div>
                                </div>
                                <div class="col-sm"></div>
                            </div>
                            <div class="row">
                                <div class="col-sm"></div>
                                <div class="col-sm" style="text-align: left">Image Analysis</div>
                                <div class="col-sm">
                                    <img src="/static/images/ajax-loader.gif" id="imageDataWaiting">
                                    <div id="imageDataSuccess">✅</div>
                                    <div id="imageDataFailure">❌</div>
                                </div>
                                <div class="col-sm"></div>
                            </div>
                        </div>
                        <div id="embedOutput"></div>
                    </div>
                </div>
            </div>
        </div>



        <script>

            workstatus = document.getElementById("embedWorkStatus");
            workarea = document.getElementById("embedWorkArea");

            // Thanks ArchiveNow: https://github.com/oduwsdl/archivenow
            function validateURL(textval) {
                var urlregex = /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
                return urlregex.test(textval);
            }

            function requestEmbed() {

                console.log("requestEmbed called");

                uri = document.getElementById('uri_submitted').value;

                if (validateURL(uri) == false) {
                    document.getElementById('uri_submitted').focus();
                    workarea.innerHTML = '*Enter a correct URL*'
                    workarea.style.backgroundColor = "#ff0000";
                    workarea.style.color = "#ffffff";
                    return;
                }

                workstatus.style.visibility = "inherit";

                // workarea.style.backgroundColor = "#ffffdd";

                encoded_uri = btoa(uri)

                console.log("using encoded URI " + encoded_uri)

                memento_data_svc = "/services/surrogate/" + encoded_uri + "/uriminfo"
                original_data_svc = "/services/surrogate/" + encoded_uri + "/uririnfo"
                textdata_svc = "/services/surrogate/" + encoded_uri + "/textdata"
                imagedata_svc = "/services/surrogate/" + encoded_uri + "/imagedata"

                $.ajax({
                    type: "GET",
                    url: memento_data_svc,
                    success: function(json) {
                        document.getElementById("mementoDataWaiting").style.display = "none";
                        document.getElementById("mementoDataSuccess").style.display = "inherit";
                        document.getElementById("mementoDataFailure").style.display = "none";
                        console.log("got JSON successfully: " + json);
                    },
                    error: function(data) {
                        document.getElementById("mementoDataWaiting").style.display = "none";
                        document.getElementById("mementoDataSuccess").style.display = "none";
                        document.getElementById("mementoDataFailure").style.display = "inherit";
                        document.getElementById("embedOutput").style.backgroundColor = "#ff0000";
                        document.getElementById("embedOutput").style.color = "#ffffff";
                        document.getElementById("embedOutput").insertAdjacentHTML(
                            "afterbegin", "*Failed to Acquire Memento Data*<br />"
                        );

                    }
                })

                $.ajax({
                    type: "GET",
                    url: original_data_svc,
                    success: function(json) {
                        document.getElementById("originalDataWaiting").style.display = "none";
                        document.getElementById("originalDataSuccess").style.display = "inherit";
                        document.getElementById("originalDataFailure").style.display = "none";
                        console.log("got JSON successfully: " + json);
                    },
                    error: function(data) {
                        document.getElementById("originalDataWaiting").style.display = "none";
                        document.getElementById("originalDataSuccess").style.display = "none";
                        document.getElementById("originalDataFailure").style.display = "inherit";
                        document.getElementById("embedOutput").style.backgroundColor = "#ff0000";
                        document.getElementById("embedOutput").style.color = "#ffffff";
                        document.getElementById("embedOutput").insertAdjacentHTML(
                            "afterbegin", "*Failed to Acquire Original Resource Data*<br />"
                        );

                    }
                })

                $.ajax({
                    type: "GET",
                    url: textdata_svc,
                    success: function(json) {
                        document.getElementById("textDataWaiting").style.display = "none";
                        document.getElementById("textDataSuccess").style.display = "inherit";
                        document.getElementById("textDataFailure").style.display = "none";
                        console.log("got JSON successfully: " + json);
                    },
                    error: function(data) {
                        document.getElementById("textDataWaiting").style.display = "none";
                        document.getElementById("textDataSuccess").style.display = "none";
                        document.getElementById("textDataFailure").style.display = "inherit";
                        document.getElementById("embedOutput").style.backgroundColor = "#ff0000";
                        document.getElementById("embedOutput").style.color = "#ffffff";
                        document.getElementById("embedOutput").insertAdjacentHTML(
                            "afterbegin", "*Failed to Analyze Text Data*<br />"
                        );

                    }
                })

                $.ajax({
                    type: "GET",
                    url: imagedata_svc,
                    success: function(json) {
                        document.getElementById("imageDataWaiting").style.display = "none";
                        document.getElementById("imageDataSuccess").style.display = "inherit";
                        document.getElementById("imageDataFailure").style.display = "none";
                        console.log("got JSON successfully: " + json);
                    },
                    error: function(data) {
                        document.getElementById("imageDataWaiting").style.display = "none";
                        document.getElementById("imageDataSuccess").style.display = "none";
                        document.getElementById("imageDataFailure").style.display = "inherit";
                        document.getElementById("embedOutput").style.backgroundColor = "#ff0000";
                        document.getElementById("embedOutput").style.color = "#ffffff";
                        document.getElementById("embedOutput").insertAdjacentHTML(
                            "afterbegin", "*Failed to Analyze Image Data*<br />"
                        );

                    }
                })


                // workarea.innerHTML = 'Generating social card for URL ' + uri;

                // for useful status messages, we will need to use different endpoints for each
                // item we want to investigate the status on, otherwise we use websockets
                // see https://developer.mozilla.org/en-US/docs/Web/API/WindowBase64/Base64_encoding_and_decoding
                // for making an identifier using base64 from a URI

                // $.ajax({
                //     type: "GET",
                //     url: "response-mockup3.json",
                //     success: function(json) {
                //         console.log(json);
                //         console.log('WTF?');
                        // social_card_area = "";
                        // social_card_area += '<div class="row"><div class="col-sm">';
                        // social_card_area += '<h2>Social Card Generated for URL ' + uri + '</h2>';
                        // social_card_area += '</div></div>';
                        // social_card_area += '<div class="row">';
                        // social_card_area += '<div class="col-sm">If you want to include this social card in your web page</div>';
                        // social_card_area += '<div class="col-sm">copy the code below and paste it into your page HTML.</div>';
                        // social_card_area += '</div>';
                        // social_card_area += '<div class="row">';
                        // social_card_area += '<div class="col-sm">' + json['socialcardtext'] + '</div>';
                        // social_card_area += '<div class="col-sm"><textarea>' + json['socialcardtext'] + '</textarea></div>';
                        // social_card_area += '</div>';
                        // workarea.innerHTML = social_card_area;
                        // workarea.style.backgroundColor = "#ffffff";
                        // workarea.style.color = "#000000";
                //     },
                //     complete: function() {
                //         wi.style.opacity = 0;
                //     }
                // })

            }

            function clearEmbed() {
                workarea.style.opacity = 0;
                document.getElementById('uri_submitted').clear;
            }
        </script>
    </body>
</html>