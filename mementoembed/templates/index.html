<html lang="en">
    <head>
        <title>MementoEmbed - Create Embeddable Content of your Mementos</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <style>

            #mementoDataFailure,
            #mementoDataSuccess {
                display: none;
            }

            #embedErrorStatus {
                background-color: #ff0000;
                color: #ffffff;
                font-weight: bolder;
            }

        </style>

    </head>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
        <script src="/static/js/mementoembed.js" type="text/javascript"></script>
        <div class="container">
            <h1 style="text-align: center">MementoEmbed</h1>
            <div class="row">
                <div class="col-sm" style="text-align: center">
                    <p>Generate an embeddable social card of a memento for your web page or blog. Just enter a URL below.</p>
                    <!-- <p>If the URL is not a memento, it will be submitted to a web archive and your embeddable card will point to a memento.</p> -->
                </div>
            </div>
            <div class="row" style="text-align: center">
                <div class="col-sm" style="text-align: center">
                    <form action="#">
                    <input type="text" id="uri_submitted" class="form-control form-control-lg" size="100" placeholder="Type URL here">
                    <br />
                    <button id="createSocialCard" type="button" class="btn btn-primary">Create a Social Card</button>
                    <button id="clearURL" type="reset" class="btn btn-secondary">Clear URL</button>
                    </form>
                </div>
            </div>
            <div class="row" style="text-align: center">
                <div class="col-sm" style="text-align: center">
                    <hr />
                    <div id="embedWorkArea">
                        <div id="embedErrorStatus"></div>
                        <div id="embedWorkStatus"></div>
                        <div id="embedOutput"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>

            workstatus = document.getElementById("embedWorkStatus");
            workarea = document.getElementById("embedWorkArea");
            workerror = document.getElementById("embedErrorStatus");
            workoutput = document.getElementById("embedOutput");

            // Thanks ArchiveNow: https://github.com/oduwsdl/archivenow
            function validateURL(textval) {
                var urlregex = /^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
                return urlregex.test(textval);
            }

            function setWorking() {
                workoutput.innerHTML = '<img src="/static/images/ajax-loader.gif" id="mementoDataWaiting">';
            }

            function setOutput(outputdata) {
                workoutput.style.backgroundColor = "#ffffff";
                workoutput.style.color = "#000000";
                workerror.innerHTML = "";
                workoutput.innerHTML = outputdata;
            }

            function setError(errordata) {
                console.log("setting error to " + errordata);
                workerror.style.backgroundColor = "#ff0000";
                workerror.style.color = "#ffffff";
                workerror.style.fontWeight = "bolder";
                workoutput.innerHTML = "";
                workerror.innerHTML = errordata;
            }

            // function requestEmbed() {
            $( "#createSocialCard" ).bind( "click" , function() {

                console.log("requestEmbed called");
                setWorking();

                uri = document.getElementById('uri_submitted').value;

                if (validateURL(uri) == false) {
                    console.log("validateURL failed...");
                    document.getElementById('uri_submitted').focus();
                    setError('*Enter a correct URL*');
                    return;
                }

                console.log("using URI " + uri);

                encoded_uri = encodeURI(uri)

                console.log("using encoded URI " + encoded_uri)

                oembed_data_svc = "/services/oembed?url=" + encoded_uri + "&format=json"

                $.ajax({
                    type: "GET",
                    url: oembed_data_svc,
                    success: function(json) {
                        console.log("we have success with json: " + json);
                        console.log("JSON['html'] is " + json['html']);

                        social_card_area = "";
                        social_card_area += '<div class="row"><div class="col-sm">';
                        social_card_area += '<h2>Social Card Generated for URI-M <br/><span style="font-size: 12px">' + uri + '</span></h2>';
                        social_card_area += '</div></div>';
                        social_card_area += '<div class="row"><div class="col-sm"><hr /></div></div>';                        
                        social_card_area += '<div class="row">';
                        social_card_area += '<div class="col-sm">If you want to include this social card in your web page</div>';
                        social_card_area += '<div class="col-sm">copy the code below and paste it into your page HTML.</div>';
                        social_card_area += '</div>';
                        social_card_area += '<div class="row">';
                        social_card_area += '<div class="col-sm">' + json['html'] + '</div>';
                        social_card_area += '<div class="col-sm"><textarea cols="50" rows="5" id="sc_code">';
                        social_card_area += json['html'] + '</textarea>';
                        // social_card_area += '<button id="copy_sc_code">Copy Text</button>';
                        social_card_area += '</div>';
                        social_card_area += '</div>';

                        setOutput(social_card_area);

                        generate_cards();
                    },
                    error: function(data, textStatus, errorThrown) {
                        console.log("we have failure with data: " + data);
                        console.log("error: " + textStatus);
                        console.log("the HTTP status is " + data.status + " " + data.statusText);
                        console.log("response headers: " + data.getAllResponseHeaders());
                        console.log("response text: " + data.responseText);
                        
                        responseJSON = jQuery.parseJSON(data.responseText);

                        if (data.status == 0) {
                            console.log("failed to connect to oEmbed endpoint");
                            document.getElementById('uri_submitted').focus();
                            message = '*The MementoEmbed Service is Down!*';
                        } else {

                            if (data.responseText === undefined) {
                                message = "MementoEmbed failed to generate an error message"
                                error = true;
                            } else {

                                if (responseJSON['error'] == "Not a memento") {
                                    message = responseJSON['content'];
                                    output = true;
                                    error = false;
                                } else {
                                    // message = data.responseText;
                                    message = responseJSON['content']
                                }

                            }

                            console.log("failure message: " + message);
                        }

                        if ( error == true ) {
                            setError(message);
                        } else {
                            setOutput(message);
                        }
                        
                    }
                });
            });

            // function clearEmbed() {
            $( "#clearURL" ).bind( "click" , function() {
                document.getElementById('uri_submitted').clear;
                workoutput.innerHTML = "";
                workerror.innerHTML = "";
            });
        </script>
    </body>
</html>